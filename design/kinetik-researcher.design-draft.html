<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kinetik Researcher | Prozess-Analyse</title>
    <style>
        :root {
            /* Color Palette - Scientific/Clean */
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --secondary: #64748b;
            --bg-body: #f1f5f9;
            --bg-surface: #ffffff;
            --border: #e2e8f0;
            --text-main: #1e293b;
            --text-muted: #64748b;
            
            /* Status Colors */
            --success: #10b981;
            --success-bg: #ecfdf5;
            --warning: #f59e0b;
            --warning-bg: #fffbeb;
            --error: #ef4444;
            --error-bg: #fef2f2;
            --info: #3b82f6;
            --info-bg: #eff6ff;

            /* Spacing */
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --header-height: 60px;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Inter, system-ui, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Layout Grid --- */
        .app-container {
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            grid-template-rows: var(--header-height) 1fr;
            height: 100vh;
            width: 100vw;
        }

        /* --- Header --- */
        .header {
            grid-column: 1 / -1;
            background: var(--bg-surface);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--space-lg);
            z-index: 10;
        }

        .brand {
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .brand span { color: var(--primary); }

        .header-actions {
            display: flex;
            gap: var(--space-md);
        }

        /* --- Sidebar (Experiments) --- */
        .sidebar {
            background: var(--bg-surface);
            border-right: 1px solid var(--border);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: var(--space-md);
            border-bottom: 1px solid var(--border);
            background: #f8fafc;
            position: sticky;
            top: 0;
        }

        .search-box {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: white;
            font-size: 0.9rem;
        }

        .exp-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .exp-item {
            padding: 12px var(--space-md);
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.15s;
        }

        .exp-item:hover { background: var(--bg-body); }
        .exp-item.active { background: var(--info-bg); border-left: 4px solid var(--primary); }

        .exp-title { font-weight: 600; font-size: 0.9rem; margin-bottom: 4px; display: block; }
        .exp-meta { font-size: 0.75rem; color: var(--text-muted); display: flex; justify-content: space-between; }

        /* --- Main Workspace --- */
        .workspace {
            background: var(--bg-body);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* Stepper */
        .stepper {
            background: var(--bg-surface);
            padding: var(--space-md) var(--space-lg);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-muted);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            position: relative;
        }

        .step.active { color: var(--primary); font-weight: 700; }
        .step.completed { color: var(--success); }
        .step-num {
            width: 24px; height: 24px;
            border-radius: 50%;
            background: var(--border);
            color: var(--text-muted);
            display: flex; align-items: center; justify-content: center;
            font-size: 0.75rem;
        }
        .step.active .step-num { background: var(--primary); color: white; }
        .step.completed .step-num { background: var(--success); color: white; }

        .step-line {
            flex-grow: 1;
            height: 2px;
            background: var(--border);
            margin: 0 10px;
        }

        /* Content Area */
        .content-area {
            flex: 1;
            padding: var(--space-lg);
            overflow-y: auto;
        }

        /* --- Right Panel (Audit Log) --- */
        .right-panel {
            background: #f8fafc;
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .panel-header {
            padding: var(--space-md);
            font-weight: 600;
            border-bottom: 1px solid var(--border);
            background: var(--bg-surface);
            display: flex; justify-content: space-between;
        }

        .audit-list {
            padding: var(--space-md);
            overflow-y: auto;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        .audit-item {
            background: var(--bg-surface);
            padding: var(--space-sm);
            border-radius: 6px;
            border: 1px solid var(--border);
            font-size: 0.8rem;
            position: relative;
            padding-left: 12px;
        }
        .audit-item::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px;
            border-top-left-radius: 6px; border-bottom-left-radius: 6px;
            background: var(--secondary);
        }
        .audit-item.decision::before { background: var(--success); }
        .audit-item.system::before { background: var(--primary); }

        .audit-time { font-size: 0.7rem; color: var(--text-muted); margin-bottom: 4px; }
        .audit-text { line-height: 1.4; }

        /* --- Components --- */
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: 1px solid transparent;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-outline { background: white; border-color: var(--border); color: var(--text-main); }
        .btn-outline:hover { background: var(--bg-body); }
        .btn-sm { padding: 4px 8px; font-size: 0.8rem; }
        .btn-success { background: var(--success); color: white; }

        .card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: var(--space-md);
            margin-bottom: var(--space-md);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .badge.clean { background: var(--success-bg); color: var(--success); }
        .badge.warning { background: var(--warning-bg); color: var(--warning); }
        .badge.error { background: var(--error-bg); color: var(--error); }

        /* --- Specific View Styles --- */
        .mapping-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .mapping-table th, .mapping-table td { text-align: left; padding: 8px; border-bottom: 1px solid var(--border); }
        .mapping-table th { color: var(--text-muted); font-weight: 500; }

        .flag-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px; border: 1px solid var(--border); border-radius: 6px;
            margin-bottom: 8px; background: white;
        }
        .flag-severity { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 8px; }

        .question-card { border-left: 4px solid var(--warning); }
        .question-options { display: flex; gap: 8px; margin-top: 12px; }
        
        .chart-placeholder {
            width: 100%; height: 250px;
            background: #f8fafc; border: 1px solid var(--border);
            border-radius: 6px; display: flex; align-items: center; justify-content: center;
            position: relative;
        }

        /* Grid for Diagnostics */
        .diag-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--space-md); }

        /* Report Preview */
        .report-preview {
            background: white; padding: 40px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            max-width: 800px; margin: 0 auto;
            font-family: 'Times New Roman', serif;
            line-height: 1.6;
        }
        .report-preview h1 { font-size: 1.5rem; margin-bottom: 0.5rem; font-family: 'Segoe UI', sans-serif; }
        .report-preview h2 { font-size: 1.2rem; border-bottom: 1px solid #ddd; margin-top: 2rem; font-family: 'Segoe UI', sans-serif; }

        /* Toggle Switch */
        .toggle-switch { display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .toggle-input { display: none; }
        .toggle-slider {
            width: 36px; height: 20px; background: #cbd5e1;
            border-radius: 20px; position: relative; transition: .3s;
        }
        .toggle-slider::before {
            content: ""; position: absolute; height: 16px; width: 16px;
            left: 2px; bottom: 2px; background: white; border-radius: 50%; transition: .3s;
        }
        .toggle-input:checked + .toggle-slider { background: var(--primary); }
        .toggle-input:checked + .toggle-slider::before { transform: translateX(16px); }

        /* SVG Line Chart Styles */
        svg.chart { width: 100%; height: 100%; overflow: visible; }
        path.line { fill: none; stroke: var(--primary); stroke-width: 2; vector-effect: non-scaling-stroke; }
        path.line-model { fill: none; stroke: var(--error); stroke-width: 2; stroke-dasharray: 4; vector-effect: non-scaling-stroke; opacity: 0.8; }
        .axis { stroke: var(--text-muted); stroke-width: 1; }
        text.label { font-size: 10px; fill: var(--text-muted); font-family: sans-serif; }

    </style>
</head>
<body>

<div class="app-container">
    <!-- HEADER -->
    <header class="header" id="header">
        <div class="brand">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M2 20h20"></path><path d="M18 12h-6l-3 7h-6"></path><path d="M5 2l8 10"></path>
            </svg>
            Kinetik<span>Researcher</span>
        </div>
        
        <div class="header-actions">
            <span class="badge warning" id="global-status">In Bearbeitung</span>
            <button class="btn btn-primary btn-sm" onclick="app.showToast('Projekt gespeichert')">Save Project</button>
            <button class="btn btn-outline btn-sm">Help</button>
        </div>
    </header>

    <!-- LEFT SIDEBAR: EXPERIMENTS -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <input type="text" class="search-box" placeholder="Experimente suchen..." onkeyup="app.filterExperiments(this.value)">
            <div style="margin-top: 8px; display: flex; gap: 4px;">
                <button class="btn btn-outline btn-sm" style="flex:1">Filter</button>
                <button class="btn btn-outline btn-sm" style="flex:1">Sort</button>
            </div>
        </div>
        <ul class="exp-list" id="exp-list">
            <!-- Experiments rendered via JS -->
        </ul>
    </aside>

    <!-- MAIN WORKSPACE -->
    <main class="workspace">
        <!-- Stepper Navigation -->
        <div class="stepper" id="stepper">
            <!-- Stepper rendered via JS -->
        </div>

        <!-- Dynamic Content Area -->
        <div class="content-area" id="main-content">
            <!-- View Content injected here -->
        </div>
    </main>

    <!-- RIGHT PANEL: AUDIT LOG -->
    <aside class="right-panel">
        <div class="panel-header">
            Audit Log / Entscheidungen
            <button class="btn btn-outline btn-sm" style="border:none">Export</button>
        </div>
        <div class="audit-list" id="audit-log">
            <!-- Log entries rendered via JS -->
            <div class="audit-item system">
                <div class="audit-time">Just now</div>
                <div class="audit-text">Session started. User: Dr. Weber</div>
            </div>
        </div>
    </aside>
</div>

<!-- JAVASCRIPT LOGIC -->
<script>
    // --- Mock Data & Config ---
    const steps = [
        { id: 'import', label: '1. Import & Map' },
        { id: 'validate', label: '2. Validation' },
        { id: 'questions', label: '3. Questions' },
        { id: 'modeling', label: '4. Modeling' },
        { id: 'diagnostics', label: '5. Diagnostics' },
        { id: 'report', label: '6. Report' }
    ];

    const experiments = Array.from({ length: 20 }, (_, i) => ({
        id: `EXP-2024-${100 + i}`,
        name: `Reaction_Series_${String.fromCharCode(65 + (i % 5))}_Run${Math.floor(i/5)+1}`,
        status: i < 5 ? 'error' : (i < 12 ? 'warning' : 'clean'),
        date: '2024-10-22',
        dataPoints: 120 + Math.floor(Math.random() * 50)
    }));

    const questions = [
        { id: 1, q: "Einheit der Zeitspalte 't_react' ist nicht eindeutig.", context: "Wertebereich: 0 - 180. K√∂nnte [min] oder [s] sein.", options: ['Minuten [min]', 'Sekunden [s]', 'Stunden [h]'], resolved: false, answer: null },
        { id: 2, q: "Temperatur-Sprung in EXP-2024-103 bei t=40.", context: "T steigt um 5¬∞C. Ist das beabsichtigt (Rampe) oder Exothermie?", options: ['Beabsichtigt (Protokoll)', 'Reaktionsw√§rme (Exotherm)', 'Messfehler (Ignorieren)'], resolved: false, answer: null },
        { id: 3, q: "Hoher Initialwert f√ºr Nebenprodukt B.", context: "Startet bei 2.5% statt 0%. Verunreinigung im Edukt?", options: ['Ja, Edukt-Verunreinigung', 'Nein, Kalibrierfehler', 'Unbekannt (als Variable fitten)'], resolved: false, answer: null }
    ];

    const hypotheses = [
        { id: 'h1', title: 'Katalysator-Deaktivierung', likelihood: 'High', reason: 'Reaktionsrate f√§llt st√§rker als durch Eduktverbrauch erkl√§rbar.', checked: false },
        { id: 'h2', title: 'Induktionsphase', likelihood: 'Low', reason: 'Kein sigmoider Startverlauf in den ersten 5 Minuten erkennbar.', checked: false },
        { id: 'h3', title: 'Stofftransport-Limitierung', likelihood: 'Medium', reason: 'Hohe Reaktionsgeschwindigkeit bei niedriger R√ºhrerdrehzahl.', checked: false }
    ];

    // --- State Management ---
    const state = {
        currentStepIndex: 0,
        selectedExpId: experiments[0].id,
        auditLog: [],
        questions: [...questions],
        hypotheses: [...hypotheses],
        modelResult: null
    };

    // --- App Logic ---
    const app = {
        init() {
            this.renderSidebar();
            this.renderStepper();
            this.renderView();
            this.addToLog('System', 'Projekt "Kinetic_Study_V2" geladen.');
        },

        // Rendering Components
        renderSidebar() {
            const list = document.getElementById('exp-list');
            list.innerHTML = experiments.map(exp => `
                <li class="exp-item ${exp.id === state.selectedExpId ? 'active' : ''}" onclick="app.selectExperiment('${exp.id}')">
                    <span class="exp-title">${exp.name}</span>
                    <div class="exp-meta">
                        <span>${exp.id}</span>
                        <span class="badge ${exp.status}">${exp.status}</span>
                    </div>
                </li>
            `).join('');
        },

        renderStepper() {
            const container = document.getElementById('stepper');
            container.innerHTML = steps.map((step, index) => {
                let cls = 'step';
                if (index === state.currentStepIndex) cls += ' active';
                if (index < state.currentStepIndex) cls += ' completed';
                return `
                    <div class="${cls}" onclick="app.goToStep(${index})">
                        <div class="step-num">${index < state.currentStepIndex ? '‚úì' : index + 1}</div>
                        <span>${step.label}</span>
                    </div>
                    ${index < steps.length - 1 ? '<div class="step-line"></div>' : ''}
                `;
            }).join('');
        },

        renderAuditLog() {
            const container = document.getElementById('audit-log');
            container.innerHTML = state.auditLog.map(entry => `
                <div class="audit-item ${entry.type === 'Decision' ? 'decision' : 'system'}">
                    <div class="audit-time">${entry.time}</div>
                    <div class="audit-text"><b>${entry.type}:</b> ${entry.msg}</div>
                </div>
            `).join('') + '<div style="margin-top:auto; font-size:0.75rem; color:#94a3b8; text-align:center;">Log Ende</div>';
            container.scrollTop = container.scrollHeight;
        },

        // Actions
        selectExperiment(id) {
            state.selectedExpId = id;
            this.renderSidebar();
            this.renderView(); // Re-render current view with new context
        },

        goToStep(index) {
            state.currentStepIndex = index;
            this.renderStepper();
            this.renderView();
        },

        addToLog(type, msg) {
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second:'2-digit' });
            state.auditLog.push({ type, msg, time });
            this.renderAuditLog();
        },

        showToast(msg) {
            // Simple visual feedback
            const btn = document.querySelector('.btn-primary');
            const oldText = btn.innerText;
            btn.innerText = "Saved!";
            btn.style.background = "var(--success)";
            setTimeout(() => {
                btn.innerText = oldText;
                btn.style.background = "";
            }, 1500);
        },

        // View Routing
        renderView() {
            const content = document.getElementById('main-content');
            const stepId = steps[state.currentStepIndex].id;
            const currentExp = experiments.find(e => e.id === state.selectedExpId);

            switch(stepId) {
                case 'import':
                    content.innerHTML = this.views.import(currentExp);
                    break;
                case 'validate':
                    content.innerHTML = this.views.validate(currentExp);
                    break;
                case 'questions':
                    content.innerHTML = this.views.questions();
                    break;
                case 'modeling':
                    content.innerHTML = this.views.modeling(currentExp);
                    this.drawChart('chart-container', false); // Draw raw data
                    break;
                case 'diagnostics':
                    content.innerHTML = this.views.diagnostics();
                    break;
                case 'report':
                    content.innerHTML = this.views.report();
                    break;
            }
        },

        // --- View Templates ---
        views: {
            import(exp) {
                return `
                    <h2>Daten Import & Mapping</h2>
                    <div class="card" style="border-style: dashed; text-align: center; padding: 40px; background: #f8fafc;">
                        <div style="color: var(--primary); font-size: 2rem; margin-bottom: 10px;">‚òÅÔ∏è</div>
                        <p>Drag & Drop CSV/Excel Dateien hierher oder <a href="#" style="color:var(--primary)">durchsuchen</a>.</p>
                        <p style="font-size: 0.8rem; color: var(--text-muted)">Aktuell geladen: 20 Dateien</p>
                    </div>
                    
                    <h3>Spalten Zuordnung (${exp.name})</h3>
                    <div class="card">
                        <table class="mapping-table">
                            <thead><tr><th>Quell-Spalte</th><th>Vorschau (Zeile 1)</th><th>Semantische Rolle</th><th>Einheit</th></tr></thead>
                            <tbody>
                                <tr><td>Time_min</td><td>0.00</td>
                                    <td><select class="btn btn-outline btn-sm"><option selected>Zeit (t)</option></select></td>
                                    <td><span class="badge clean">min</span></td>
                                </tr>
                                <tr><td>React_Temp</td><td>25.4</td>
                                    <td><select class="btn btn-outline btn-sm"><option selected>Temperatur (T)</option></select></td>
                                    <td><span class="badge clean">¬∞C</span></td>
                                </tr>
                                <tr><td>Conc_A</td><td>1.20</td>
                                    <td><select class="btn btn-outline btn-sm"><option selected>Konzentration (A)</option></select></td>
                                    <td><span class="badge clean">mol/L</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
            },
            validate(exp) {
                return `
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h2>Validierung: ${exp.name}</h2>
                        <div>
                            <span class="badge error">3 Errors</span>
                            <span class="badge warning">2 Warnings</span>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h4 style="margin-top:0">Erkannte Flags</h4>
                            ${['Zeitstempel nicht monoton (Zeile 45-48)', 'Temperatur Ausrei√üer (> 3 Sigma)', 'Konzentration negativ (Zeile 102)'].map(err => `
                                <div class="flag-item" style="border-left: 4px solid var(--error);">
                                    <div>
                                        <div style="font-weight:600; font-size:0.9rem;">${err}</div>
                                        <div style="font-size:0.8rem; color:var(--text-muted);">Validation Rule #104</div>
                                    </div>
                                    <button class="btn btn-outline btn-sm" onclick="app.goToStep(2)">Ask User</button>
                                </div>
                            `).join('')}
                             <div class="flag-item" style="border-left: 4px solid var(--warning);">
                                <div>
                                    <div style="font-weight:600; font-size:0.9rem;">Rauschen hoch in Endphase</div>
                                </div>
                                <button class="btn btn-outline btn-sm">Ignore</button>
                            </div>
                        </div>
                        
                        <div class="card">
                            <h4>Rohdaten Vorschau (Plot)</h4>
                            <div class="chart-placeholder">
                                <span style="color:var(--text-muted)">[Mini-Plot der Ausrei√üer]</span>
                            </div>
                            <div style="margin-top:10px; font-size:0.8rem; color:var(--text-muted);">
                                Zeile 45: t=10.5, t_next=10.2 (Fehler)<br>
                                Zeile 46: t=10.6
                            </div>
                        </div>
                    </div>
                `;
            },
            questions() {
                const activeQ = state.questions.find(q => !q.resolved);
                if (!activeQ) return `
                    <div style="text-align:center; margin-top:50px;">
                        <div style="font-size:3rem;">üéâ</div>
                        <h2>Alle Fragen gekl√§rt!</h2>
                        <p>Sie k√∂nnen mit der Modellierung fortfahren.</p>
                        <button class="btn btn-primary" onclick="app.goToStep(3)">Zur Modellierung</button>
                    </div>`;

                return `
                    <h2>Human-in-the-Loop Kl√§rung</h2>
                    <p style="color:var(--text-muted)">Die KI ben√∂tigt Expertenwissen f√ºr ${state.questions.filter(q=>!q.resolved).length} offene Punkte.</p>
                    
                    <div class="card question-card" style="margin-top:20px; padding:30px;">
                        <div class="badge warning" style="margin-bottom:10px;">Frage #${activeQ.id}</div>
                        <h3 style="margin-top:0">${activeQ.q}</h3>
                        <p style="font-style:italic; color:#475569;">Context: ${activeQ.context}</p>
                        
                        <div class="question-options">
                            ${activeQ.options.map(opt => `
                                <button class="btn btn-outline" onclick="app.resolveQuestion(${activeQ.id}, '${opt}')">${opt}</button>
                            `).join('')}
                        </div>
                        
                        <div style="margin-top:20px; border-top:1px solid #eee; padding-top:15px;">
                            <label style="font-size:0.8rem; font-weight:600;">Freitext Anmerkung (Optional)</label>
                            <input type="text" class="search-box" style="margin-top:5px;" placeholder="Z.B. Begr√ºndung f√ºr Audit Log...">
                        </div>
                    </div>
                    
                    <div style="margin-top:10px;">
                        <button class="btn btn-outline btn-sm" style="color:var(--text-muted)">Frage √ºberspringen</button>
                    </div>
                `;
            },
            modeling(exp) {
                return `
                    <div style="display: grid; grid-template-columns: 250px 1fr; gap: 20px; height: 100%;">
                        <!-- Left Controls -->
                        <div style="display:flex; flex-direction:column; gap:15px;">
                            <h3>Modellierung</h3>
                            
                            <label class="toggle-switch">
                                <span style="font-size:0.9rem;">Multi-Experiment Fit</span>
                                <input type="checkbox" class="toggle-input">
                                <span class="toggle-slider"></span>
                            </label>

                            <div class="card">
                                <label style="font-size:0.8rem; font-weight:600;">Modell-Typ</label>
                                <select class="search-box" style="margin-bottom:10px;">
                                    <option>Kinetik n-ter Ordnung (A -> P)</option>
                                    <option>Folgereaktion (A -> B -> C)</option>
                                    <option>Michaelis-Menten</option>
                                </select>

                                <label style="font-size:0.8rem; font-weight:600;">Solver Einstellungen</label>
                                <div style="margin-top:5px; font-size:0.9rem;">
                                    <label><input type="checkbox" checked> Temp-Abh√§ngigkeit (Arrhenius)</label><br>
                                    <label><input type="checkbox"> Gewichtete Residuen</label>
                                </div>
                            </div>

                            <button class="btn btn-primary" onclick="app.runFit()">Fit Simulieren ‚ñ∂</button>
                            
                            ${state.modelResult ? `
                                <div class="card" style="background:#ecfdf5; border-color:#10b981;">
                                    <h4 style="margin:0; color:#065f46;">Fit Konvergiert</h4>
                                    <div style="font-size:0.85rem; margin-top:5px;">
                                        RMSE: 0.042<br>
                                        R¬≤: 0.985
                                    </div>
                                </div>
                            ` : ''}
                        </div>

                        <!-- Main Plot Area -->
                        <div style="display:flex; flex-direction:column; gap:10px;">
                            <div class="chart-placeholder" id="chart-container" style="flex:1; background:white;">
                                <!-- SVG Chart inserted here -->
                            </div>
                            
                            ${state.modelResult ? `
                                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
                                    <div class="card"><div style="font-size:0.8rem; color:var(--text-muted);">k (Rate Constant)</div><div style="font-weight:bold; font-size:1.1rem;">0.024 <span style="font-size:0.8rem; font-weight:normal;">1/min</span></div></div>
                                    <div class="card"><div style="font-size:0.8rem; color:var(--text-muted);">Ea (Activation Energy)</div><div style="font-weight:bold; font-size:1.1rem;">45.2 <span style="font-size:0.8rem; font-weight:normal;">kJ/mol</span></div></div>
                                    <div class="card"><div style="font-size:0.8rem; color:var(--text-muted);">n (Order)</div><div style="font-weight:bold; font-size:1.1rem;">1.05 <span style="font-size:0.8rem; font-weight:normal;">(fixed ~1)</span></div></div>
                                </div>
                            ` : '<div style="text-align:center; padding:20px; color:var(--text-muted); border:1px dashed var(--border); border-radius:6px;">Klicken Sie "Fit Simulieren" f√ºr Ergebnisse</div>'}
                        </div>
                    </div>
                `;
            },
            diagnostics() {
                return `
                    <h2>Diagnose & Hypothesen</h2>
                    <p style="color:var(--text-muted); margin-bottom:20px;">Automatisierte √úberpr√ºfung chemisch-physikalischer Ph√§nomene basierend auf Residuen.</p>

                    <div class="diag-grid">
                        ${state.hypotheses.map(h => `
                            <div class="card" style="border-top: 4px solid ${h.likelihood === 'High' ? 'var(--error)' : (h.likelihood === 'Medium' ? 'var(--warning)' : 'var(--success)')}">
                                <div style="display:flex; justify-content:space-between;">
                                    <h3 style="margin:0; font-size:1rem;">${h.title}</h3>
                                    <span class="badge ${h.likelihood === 'High' ? 'error' : (h.likelihood === 'Medium' ? 'warning' : 'clean')}">${h.likelihood} Prob.</span>
                                </div>
                                <p style="font-size:0.9rem; color:var(--text-muted); min-height:40px;">${h.reason}</p>
                                
                                ${h.checked ? 
                                    `<div style="background:#f1f5f9; padding:8px; border-radius:4px; font-size:0.85rem; margin-top:10px;">
                                        ‚úÖ <b>Check Result:</b> Keine signifikante Verbesserung des Modells bei Einbezug (AIC steigt).
                                     </div>` 
                                    : 
                                    `<button class="btn btn-outline btn-sm" style="width:100%; margin-top:10px;" onclick="app.checkHypothesis('${h.id}')">Hypothese Pr√ºfen</button>`
                                }
                            </div>
                        `).join('')}
                    </div>

                    <h3 style="margin-top:30px;">Vorschl√§ge f√ºr Folge-Experimente</h3>
                    <ul style="background:white; border:1px solid var(--border); border-radius:6px; padding:0; list-style:none;">
                        <li style="padding:15px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <b>Variation Edukt-Konzentration</b><br>
                                <span style="font-size:0.85rem; color:var(--text-muted);">Um Ordnung n=2 vs n=1 sicher zu unterscheiden.</span>
                            </div>
                            <button class="btn btn-primary btn-sm">Planen</button>
                        </li>
                        <li style="padding:15px; display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <b>Isothermer Lauf bei 40¬∞C</b><br>
                                <span style="font-size:0.85rem; color:var(--text-muted);">Datenl√ºcke im mittleren Temperaturbereich schlie√üen.</span>
                            </div>
                            <button class="btn btn-primary btn-sm">Planen</button>
                        </li>
                    </ul>
                `;
            },
            report() {
                const now = new Date().toLocaleDateString();
                return `
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h2>Finaler Report</h2>
                        <div style="display:flex; gap:10px;">
                            <button class="btn btn-outline" onclick="app.showToast('JSON kopiert')">Copy JSON</button>
                            <button class="btn btn-primary" onclick="window.print()">Export PDF</button>
                        </div>
                    </div>
                    
                    <div class="report-preview">
                        <div style="text-align:center; border-bottom:2px solid #333; padding-bottom:20px; margin-bottom:30px;">
                            <h1 style="margin:0;">Kinetische Evaluierung</h1>
                            <p style="margin:0; color:#666;">Project: Kinetic_Study_V2 | Date: ${now}</p>
                        </div>

                        <h2>1. Zusammenfassung</h2>
                        <p>Es wurden 20 Experimente analysiert. Ein Reaktionsmodell <b>1. Ordnung</b> beschreibt die Daten mit hoher G√ºte (R¬≤ > 0.98). Hinweise auf Katalysator-Deaktivierung wurden gepr√ºft, aber verworfen.</p>

                        <h2>2. Modell Parameter</h2>
                        <table style="width:100%; border-collapse:collapse; margin-top:10px;">
                            <tr style="background:#eee;"><th style="text-align:left; padding:8px;">Parameter</th><th style="text-align:left; padding:8px;">Wert</th><th style="text-align:left; padding:8px;">Unit</th></tr>
                            <tr><td style="padding:8px; border-bottom:1px solid #ddd;">Activation Energy (Ea)</td><td style="padding:8px; border-bottom:1px solid #ddd;">45.2 ¬± 1.2</td><td style="padding:8px; border-bottom:1px solid #ddd;">kJ/mol</td></tr>
                            <tr><td style="padding:8px; border-bottom:1px solid #ddd;">Pre-exponential (A)</td><td style="padding:8px; border-bottom:1px solid #ddd;">2.4e5</td><td style="padding:8px; border-bottom:1px solid #ddd;">1/s</td></tr>
                        </table>

                        <h2>3. Audit Trail (Auszug)</h2>
                        <ul style="font-family:'Courier New', monospace; font-size:0.9rem;">
                            ${state.auditLog.slice(-3).map(l => `<li>[${l.time}] ${l.type}: ${l.msg}</li>`).join('')}
                        </ul>

                        <h2>4. Offene Punkte</h2>
                        <p>Experiment EXP-2024-100 wurde aufgrund von Datenfehlern aus dem Fit ausgeschlossen.</p>
                    </div>
                `;
            }
        },

        // --- Interaction Handlers ---
        resolveQuestion(id, decision) {
            const qIndex = state.questions.findIndex(q => q.id === id);
            state.questions[qIndex].resolved = true;
            state.questions[qIndex].answer = decision;
            
            this.addToLog('Decision', `Frage #${id} gekl√§rt. Antwort: "${decision}"`);
            this.renderView();
        },

        runFit() {
            // Simulate processing
            const btn = document.querySelector('.btn-primary');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'Rechne...';
            btn.style.opacity = '0.7';

            setTimeout(() => {
                state.modelResult = true;
                btn.innerHTML = originalText;
                btn.style.opacity = '1';
                this.renderView();
                this.drawChart('chart-container', true); // Draw with fit line
                this.addToLog('System', 'Modell Fit "Ordnung 1" durchgef√ºhrt. Konvergenz erreicht.');
            }, 800);
        },

        checkHypothesis(id) {
            const h = state.hypotheses.find(x => x.id === id);
            h.checked = true;
            this.addToLog('System', `Hypothese "${h.title}" gepr√ºft. Ergebnis negativ.`);
            this.renderView();
        },

        filterExperiments(term) {
            // Basic filtering visual only
            const items = document.querySelectorAll('.exp-item');
            term = term.toLowerCase();
            items.forEach(item => {
                const text = item.innerText.toLowerCase();
                item.style.display = text.includes(term) ? 'block' : 'none';
            });
        },

        // --- Charting Utility (SVG) ---
        drawChart(containerId, showFit) {
            const container = document.getElementById(containerId);
            if (!container) return;

            // Generate Fake Data
            const width = container.offsetWidth;
            const height = container.offsetHeight;
            const points = [];
            const fitPoints = [];
            
            // Generate noisy exponential decay data
            for(let x=0; x<=100; x+=2) {
                const y_ideal = 90 * Math.exp(-0.03 * x);
                const noise = (Math.random() - 0.5) * 5;
                const y_real = y_ideal + noise;
                
                // Scale to SVG coords (pad 20px)
                const sx = (x / 100) * (width - 40) + 20;
                const sy = height - 20 - (y_real / 100) * (height - 40);
                const sy_fit = height - 20 - (y_ideal / 100) * (height - 40);

                points.push(`${sx},${sy}`);
                fitPoints.push(`${sx},${sy_fit}`);
            }

            const pathData = "M " + points.join(" L ");
            const fitPathData = "M " + fitPoints.join(" L ");

            const svg = `
                <svg class="chart" viewBox="0 0 ${width} ${height}">
                    <!-- Axes -->
                    <line x1="20" y1="${height-20}" x2="${width-10}" y2="${height-20}" class="axis"/>
                    <line x1="20" y1="${height-20}" x2="20" y2="10" class="axis"/>
                    <text x="${width/2}" y="${height-5}" class="label" text-anchor="middle">Zeit (t)</text>
                    <text x="10" y="${height/2}" class="label" transform="rotate(-90 10,${height/2})" text-anchor="middle">Conc</text>
                    
                    <!-- Data Line -->
                    <path d="${pathData}" class="line" />
                    
                    <!-- Fit Line (Optional) -->
                    ${showFit ? `<path d="${fitPathData}" class="line-model" />` : ''}
                    
                    <!-- Legend -->
                    <g transform="translate(${width-100}, 20)">
                        <rect width="90" height="40" fill="white" stroke="#ccc" rx="4"/>
                        <line x1="10" y1="15" x2="30" y2="15" stroke="var(--primary)" stroke-width="2"/>
                        <text x="35" y="18" class="label" style="font-size:9px">Exp Data</text>
                        ${showFit ? `
                        <line x1="10" y1="30" x2="30" y2="30" stroke="var(--error)" stroke-width="2" stroke-dasharray="4"/>
                        <text x="35" y="33" class="label" style="font-size:9px">Model Fit</text>
                        ` : ''}
                    </g>
                </svg>
            `;
            container.innerHTML = svg;
        }
    };

    // Initialize
    window.onload = () => app.init();

</script>
</body>
</html>

